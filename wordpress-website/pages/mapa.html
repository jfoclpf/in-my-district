<!-- wp:html -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.0/MarkerCluster.Default.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/leaflet.markercluster.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<!-- /wp:html -->

<!-- wp:html -->
<select id="map_view_select" style="margin-bottom:10px; margin-right:15px" name="Tipo de visualização do mapa"></select>
<span id="map_view_select_count"></span>
<div id="map" style="height: 550px"></div>
<!-- /wp:html -->

<!-- wp:html -->
<script language="JavaScript">
/***********************************************************************/
/* When the user clicks on the Map section on the left panel, the user
   should see a map of all complaints previously submitted by all users
   These complaints are anonymously stored in the database             */

/* eslint no-var: off */
/* eslint camelcase: off */
/* eslint no-prototype-builtins: off */
/* global app, device, cordova, $, performance, L, DEBUG */

$(document).ready(()=> {
	$('footer').hide()
})

const app = {}

app.map = (function (thisModule) {
  const requestHistoricUrl = 'https://in-my-district.joaopimentel.com/serverapp_get_historic'
  const requestImageUrl = 'https://in-my-district.joaopimentel.com/image_server' // folder where all the images are stored
  const anomaliesUrl = 'https://raw.githubusercontent.com/jfoclpf/in-my-district/main/www/json/anomalies.json'
  const mapIconUrl = 'https://raw.githubusercontent.com/jfoclpf/in-my-district/main/www/img/map_icon.png'

  var map
  var markersGroups // groups of markers, by type of anomaly
  var allDbEntries // all entries fetched from database
  var isMapInitiated = false

  function init () {
    // populate select box to select map view, i.e, filter ocurrences/drops in the map
    markersGroups = {
      all: { select: 'Todas as anomalias' }
    }

		$.getJSON(anomaliesUrl, function (data) {
			// populates yet with type of anomalies: faixa_bus, baixa_bus, etc.
			const anomalies = data
			for (const anomaly of anomalies) {
                                if (anomaly.list) {
 				  const anomaly1Code = anomaly.list[0].code.slice(0, 2) // ex: "PA", "HU", etc.
				  markersGroups[anomaly1Code] = {}
				  markersGroups[anomaly1Code].select = anomaly.topic
                                }
			}

			// to get all entries to show on the map, it does it in the init in the background
			// after opening the app for faster processing when user clicks on map section
			var tLoadMapInit = performance.now() // to measure 
			getAllEntries((err) => {
				if (!err) {
				  processMapMarkers()
				  initializeMap(() => {
					  isMapInitiated = true
					  console.log('Processing map took ' + Math.round(performance.now() - tLoadMapInit) + ' milliseconds')
				  })
					$('#map_view_select').trigger('change')
				}
			})

			// populates select box
			for (const key in markersGroups) {
				if (markersGroups.hasOwnProperty(key)) {
				$('#map_view_select').append(`<option value="${key}">${markersGroups[key].select}</option>`)
				}
			}

			$('#map_view_select').on('change', function () {
			  var totalNumberOfAnomalies, toSolveAnomalies, solvedAnomalies
				if (this.value === 'all') {
					totalNumberOfAnomalies = allDbEntries.length
					toSolveAnomalies = allDbEntries.filter(e => !Boolean(e.ocorrencia_resolvida)).length
					solvedAnomalies = allDbEntries.filter(e => Boolean(e.ocorrencia_resolvida)).length
				} else {
				  let filteredAnomalies = allDbEntries.filter(e => e.anomaly_code.slice(0,2) === this.value)
					totalNumberOfAnomalies	= filteredAnomalies.length
					toSolveAnomalies = filteredAnomalies.filter(e => !Boolean(e.ocorrencia_resolvida)).length
					solvedAnomalies = filteredAnomalies.filter(e => Boolean(e.ocorrencia_resolvida)).length
				}
				$('#map_view_select_count').text(`${totalNumberOfAnomalies} anomalias (${solvedAnomalies} resolvidas e ${toSolveAnomalies} por resolver)`)
				tryToShowMap(this.value)
			})
			
			tryToShowMap($('#map_view_select').val())
		})
  }
  
    // does not show map until the DB entries are loaded
  function tryToShowMap (selectOption) {
    if (!isMapInitiated) {
      setTimeout(() => {
        if (isMapInitiated) {
          showMap(selectOption)
        } else {
          tryToShowMap(selectOption)
        }
      }, 500)
    } else {
      showMap(selectOption)
    }
  }

  // selectOption can be: 'all', 'mine' or the respective legal basis ('passeios', 'na_passadeira', etc.)
  function showMap (selectOption) {
    // clears all layers from previous selections
    for (const key in markersGroups) {
      if (
        markersGroups.hasOwnProperty(key) &&
        markersGroups[key].markerClusterGroup &&
        markersGroups[key].markerClusterGroup.getLayers().length
      ) {
        map.removeLayer(markersGroups[key].markerClusterGroup)
      }
    }

    if (
      markersGroups[selectOption] &&
      markersGroups[selectOption].markerClusterGroup.getLayers().length
    ) {
      map.addLayer(markersGroups[selectOption].markerClusterGroup)
    }
  }

  function initializeMap (callback) {
    // coordinates of Lisbon for map center
    var latitude = 38.736946
    var longitude = -9.142685

    const mapOptions = {
      center: [latitude, longitude],
      zoom: 6,
      maxBounds: L.latLngBounds(L.latLng(43.882057, -11.030141), L.latLng(35.942436, -4.104133)),
      zoomControl: true,
      closePopupOnClick: false
    }

    map = L.map('map', mapOptions)

    // add the OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		  attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19,
      minZoom: 6,
      subdomains: ['a', 'b', 'c']
    }).addTo(map)

    setInterval(function () {
      map.invalidateSize()
    }, 500)

    map.on('popupopen', function (e) {
      $('img.photo-in-popup').on('load', function () {
        e.popup.update()
      })
    })

    // when map is loaded
    map.whenReady(function () {
      map.invalidateSize()
      callback()
    })
  }

  function getAllEntries (callback) {
    // because there's parameter uuid, it gets all entries with PROD=1
    $.ajax({
      url: requestHistoricUrl,
      type: 'GET',
      crossDomain: true,
      success: function (data) {
        if (data && data.length) {
          console.log('Data for map obtained from database with success. Returned: ', data)
          allDbEntries = data
          callback()
        } else {
          const errMessage = 'There was an error getting the data, data fetched but is empty'
          console.error(errMessage)
          callback(errMessage)
        }
      },
      error: function (error) {
        console.error('There was an error getting all the entries')
        console.error(error)
        callback(error)
      }
    })
  }

  function processMapMarkers () {
    // create an array for each type of occurence
    for (const key in markersGroups) {
      if (markersGroups.hasOwnProperty(key)) {
        markersGroups[key].markerClusterGroup = L.markerClusterGroup(
          { disableClusteringAtZoom: 12, spiderfyOnMaxZoom: false }
        )
      }
    }

    // Sort markers and infowindows to the map
    const dbEntriesLength = allDbEntries.length
    const mapIcon = L.icon({
      iconUrl: mapIconUrl,
      iconSize: [50, 50],
      iconAnchor: [25, 50]
    })

    for (let i = 0; i < dbEntriesLength; i++) {
      const el = allDbEntries[i]

      const marker = L.marker(
        [el.data_coord_latit, el.data_coord_long],
        { icon: mapIcon }
      )

      let htmlInfoContent =
        '<div style="width:200px">' +
          `<b>Ocorrência</b>: ${el.anomaly1} - ${el.anomaly2}<br>` +
          `<b>Local</b>: ${el.data_local} n. ${el.data_num_porta}, ${el.data_concelho}<br>` +
          `<b>Data</b>: ${(new Date(el.data_data)).toLocaleDateString('pt-PT')} às ${el.data_hora.slice(0, 5)}<br>` +
          `<b>Município</b>: ${el.data_concelho}<br>` +
          `<b>Freguesia</b>: ${el.data_freguesia}<br>`

      for (var photoIndex = 1; photoIndex <= 4; photoIndex++) {
        if (el['foto' + photoIndex]) {
          const photoUrl = requestImageUrl + '/' + el['foto' + photoIndex]
          htmlInfoContent += `<img class="photo-in-popup" width="200px" src="${photoUrl}">`
        }
      }

      htmlInfoContent += '</div>'

      const popup = L.popup({ closeOnClick: false, autoClose: false, autoPan: true, maxHeight: 400 })
        .setContent(htmlInfoContent)

      marker.bindPopup(popup)

      const anomaly1Code = el.anomaly_code.slice(0, 2) // ex: "PA", "HU", etc.
      if (markersGroups[anomaly1Code]) {
        markersGroups[anomaly1Code].markerClusterGroup.addLayer(marker)
      }
      markersGroups.all.markerClusterGroup.addLayer(marker)
    }
  }

  thisModule.init = init

  return thisModule
})(app.map || {})

app.map.init()

</script>
<!-- /wp:html -->
